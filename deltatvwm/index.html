<!DOCTYPE html>
<html lang="pt">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contador de Likes</title>
    <!-- Link para o Odometer CSS -->
    <link rel="stylesheet" href="https://cdn.rawgit.com/HubSpot/odometer/gh-pages/themes/odometer-theme-default.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f4f4f4;
            margin: 0;
        }

        .counter-container {
            text-align: center;
            /* background-color: #fff; */
            padding: 30px;
            border-radius: 10px;
            /* box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2); */
            width: 300px;
        }

        .progress-bar-container {
            position: relative;
            width: 100%;
            height: 60px;
            background-color: #ddd;
            border-radius: 10px;
            margin-top: 20px;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #292fb9, #6bb9f7);
            /* Azul mais forte e degradê */
            border-radius: 10px;
            transition: width 0.5s ease;
            position: absolute;
            top: 0;
            left: 0;
        }

        .progress-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: bold;
            font-size: 18px;
        }

        .title {
            font-size: 18px;
            margin-bottom: 5px;
        }

        #like-counter {
            font-size: 24px;
            font-weight: bold;
        }

        .goal {
            font-size: 18px;
            margin-left: 5px;
        }
    </style>
</head>

<body>

    <div class="counter-container">
        <!-- Barra de Progresso -->
        <div class="progress-bar-container">
            <div id="progress-bar" class="progress-bar"></div>
            <div class="progress-content">
                <div class="title">Meta de Like</div>
                <div id="like-counter">0/100</div>
            </div>
        </div>
    </div>
    </div>

    <!-- Inclua o Odometer.js -->
    <script src="https://cdn.rawgit.com/HubSpot/odometer/gh-pages/odometer.js"></script>
    <script>
        const apiKey = "AIzaSyCfYdJr8i8CdybGPKWlM1N9vGxcBsl5JYE";

        initGoalLike();
        async function initGoalLike() {

            if (confirm("Deseja incluir uma nova configuração?")) {
                localStorage.removeItem("videoId");
                localStorage.removeItem("channel");
                localStorage.removeItem("increment");
                localStorage.removeItem("multiple");
                localStorage.removeItem("goal");
            }

            if (!localStorage.getItem("channel") && !localStorage.getItem("videoId")) {
                let url = prompt("Informe a url do canal ou da live");
                youTubeUrlHandle(url);
            }

            if (!localStorage.getItem("goal")) {
                goal = prompt("Informe a meta inicial");
                localStorage.setItem("goal", goal)
            }

            if (!localStorage.getItem("increment")) {
                increment = prompt("De quanto em quanto deseja aumentar a meta? 0 Para deixar desativado");
                localStorage.setItem("increment", increment)
            }

            if (!localStorage.getItem("increment") || parseInt(localStorage.getItem("increment")) == 0) {
                fillMultipleField()
            }

            function fillMultipleField() {
                if (!localStorage.getItem("multiple") || parseFloat(localStorage.getItem("multiple")) < 1.1) {
                    multiple = prompt("Ao atingir a meta deseja multiplicar por?(Informe valor acima de 1)");
                    localStorage.setItem("multiple", multiple)
                    fillMultipleField()
                }
            }

            if (localStorage.getItem("channel")) {
                await getUrlLastLive();
            }


            const url = `https://www.googleapis.com/youtube/v3/videos?part=statistics&id=${localStorage.getItem("videoId")}&key=${apiKey}`;
            var currentLikes = 0;
            var goalLikes = parseInt(localStorage.getItem("goal"));
            var multiple = parseInt(localStorage.getItem("multiple"));
            var increment = parseInt(localStorage.getItem("increment"));


            const likeCounter = document.getElementById('like-counter');
            const progressBar = document.getElementById('progress-bar');
            const goalText = document.querySelector('.goal');

            likeCounter.innerHTML = `${currentLikes}/${goalLikes}`;

            setInterval(() => atualizarLikes(url), 3000);
            function atualizarLikes(url) {
                fetch(url)
                    .then(response => response.json())
                    .then(data => {
                        updateCounter(parseInt(data.items[0].statistics.likeCount));
                    })
                    .catch(error => console.error("Erro ao buscar dados:", error));
            }

            // Função para atualizar o contador e a barra de progresso
            function updateCounter(currentLikes) {
                likeCounter.innerHTML = `${currentLikes}/${goalLikes}`; // Atualiza o contador
                let progressPercentage = (currentLikes / goalLikes) * 100;
                progressBar.style.width = progressPercentage + '%'; // Atualiza a largura da barra de progresso

                if (currentLikes >= goalLikes) {
                    console.log('Atingiu a meta! Aumentando a meta...');

                    if (increment > 0) {
                        goalLikes = goalLikes + increment;
                    } else {
                        goalLikes = goalLikes * multiple;
                    }

                    likeCounter.innerHTML = `${currentLikes}/${goalLikes}`;
                    let progressPercentage = (currentLikes / goalLikes) * 100;
                    progressBar.style.width = progressPercentage + '%'; // Atualiza a largura da barra de progresso
                }
            }
        }



        async function getUrlLastLive() {
            let channelId;
            await fetch(`https://www.googleapis.com/youtube/v3/channels?part=id&forHandle=${localStorage.getItem("channel")}&key=${apiKey}`)
                .then(response => response.json())
                .then(data => {
                    channelId = data.items[0].id
                })
                .catch(error => console.error("Erro ao buscar dados:", error));

            await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=${channelId}&type=video&eventType=live&key=${apiKey}`)
                .then(response => response.json())
                .then(data => {
                    localStorage.setItem("videoId", data.items[0].id.videoId)
                })
                .catch(error => console.error("Erro ao buscar dados:", error));
        }

        function youTubeUrlHandle(url) {
            localStorage.removeItem("videoId");
            localStorage.removeItem("channel");
            if (url.includes("@")) {
                localStorage.setItem("channel", getChannel(url))
            } else if (url.includes("v=")) {
                localStorage.setItem("videoId", getYouTubeVideoID(url))
            } else if (url.includes("live")) {
                localStorage.setItem("videoId", getLiveId(url))
            }
        }

        function getYouTubeVideoID(url) {
            const urlObj = new URL(url);
            return urlObj.searchParams.get("v");
        }

        function getLiveId(url) {
            const match = url.match(/live\/([\w-]+)/);
            return match ? match[1] : null;
        }

        function getChannel(url) {
            const match = url.match(/@([\w-]+)/);
            return match ? match[0] : null;
        }
    </script>

</body>

</html>